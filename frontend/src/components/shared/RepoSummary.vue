<template>
  <div class="flex md:px-5 md:flex-col-reverse min-h-[calc(100vh-341px)]">
    <div class="max-w-[60%] sm:max-w-[100%] pt-4 pb-10 pr-5 sm:pr-0 break-words flex-1 border-t border-gray-200 md:border-t-0">
      <el-skeleton v-if="loading" class="mt-4" :rows="5" animated />
      <ParquetViewer v-if="datasetInfo" :datasetInfo="datasetInfo" :namespacePath="namespacePath" />
      <markdown-viewer
        :content="readmeContent"
        :setDefaultText="true"
        v-if="!loading"
      >
      </markdown-viewer>
    </div>
    <div class="w-[40%] sm:w-[100%] border-l border-gray-200 md:border-l-0 md:border-b md:w-full md:pl-0">
      <div class="p-[16px]">
        <div class="text-gray-500 text-base font-medium leading-[22px] md:pl-0">{{ $t('all.downloadCount') }}</div>
        <div class="text-gray-700 text-base font-semibold leading-6 mt-1 md:pl-0">{{ downloadCount }}</div>
      </div>

      <TestEndpoint
        v-if="widgetType === 'generation' && endpoint?.status === 'Running'"
        :appEndpoint="appEndpoint"
        :modelId="namespacePath"
      />

      <SpaceRelationsCard v-if="relations['spaces'] && relations['spaces'].length !== 0"
                          :namespacePath="namespacePath"
                          :spaces="relations['spaces']"
      />

      <CodeRelationsCard v-if="relations['codes'] && relations['codes'].length !== 0"
                          :namespacePath="namespacePath"
                          :codes="relations['codes']"
      />

      <DatasetRelationsCard v-if="relations['datasets'] && relations['datasets'].length !== 0"
                            :namespacePath="namespacePath"
                            :datasets="relations['datasets']"
      />

      <ModelRelationsCard v-if="relations['models'] && relations['models'].length !== 0"
                          :namespacePath="namespacePath"
                          :models="relations['models']"
      />
    </div>
  </div>
</template>

<script setup>
  import { ref, onMounted, computed } from 'vue'
  import MarkdownViewer from '../../components/shared/viewers/MarkdownViewer.vue'
  import ParquetViewer from '../../components/datasets/ParquetViewer.vue'
  import SpaceRelationsCard from '../application_spaces/SpaceRelationsCard.vue'
  import CodeRelationsCard from '../codes/CodeRelationsCard.vue';
  import DatasetRelationsCard from '../datasets/DatasetRelationsCard.vue';
  import ModelRelationsCard from '../models/ModelRelationsCard.vue';
  import TestEndpoint from '../endpoints/playground/TestEndpoint.vue'
  import useFetchApi from '../../packs/useFetchApi'
  import resolveContent from '../../packs/resolveContent'

  const props = defineProps({
    namespacePath: String,
    downloadCount: Number,
    currentBranch: String,
    widgetType: String,
    repoType: String
  })

  const loading = ref(true)
  const readmeContent = ref('')
  const relations = ref({})
  const endpoint = ref({})
  const datasetInfo = ref(null)

  const fetchData = async () => {
    const url = `/${props.repoType}s/${props.namespacePath}/blob/README.md`

    const { data } = await useFetchApi(url).json()

    if (data.value) {
      const content = resolveContent(`${props.repoType}s`, data.value.data.content, props.namespacePath)
      readmeContent.value = content
    }
    loading.value = false
  }

  const fetchParquetFilePath = async () => {
    if (props.repoType !== 'dataset') { return }

    const options = { path: '/' }
    const url = `/datasets/${props.namespacePath}/tree`

    const { data } = await useFetchApi(url, options).json()

    if (data.value) {
      const res_json = data.value
      const parquetFilePath = res_json['data'].filter(file => file.path.endsWith('.parquet'))
                              .map(file => file.path)
                              .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()))[0]
      if (parquetFilePath) {
        fetchCatalog()
      }
    }
  }

  async function fetchCatalog() {
    const { error, data } = await useFetchApi(`datasets/${props.namespacePath}/dataviewer/catalog`).json()
    if (!data.value) {
      ElMessage({
        message: error.value.msg || t('all.fetchError'),
        type: 'warning'
      })
    } else {
      datasetInfo.value = data.value.data.dataset_info 
    }
  }

  const fetchRepoRelations = async () => {
    const url = `/${props.repoType}s/${props.namespacePath}/relations`
    const { data } = await useFetchApi(url).json()
    if (data.value) {
      relations.value = data.value.data
    }
  }

  const appEndpoint = computed(() => {
    if (!endpoint.value) return ''

    return `https://${endpoint.value.proxy_endpoint}`
  })

  const fetchEndpoint = async () => {
    const url = `/models/${props.namespacePath}/serverless`

    const { data } = await useFetchApi(url).json()

    if (data.value) {
      endpoint.value = data.value.data
    }
  }

  onMounted(() => {
    fetchData()
    fetchParquetFilePath()
    fetchRepoRelations()
    if (props.repoType == 'model') {
      fetchEndpoint()
    }
  })
</script>
